#!/usr/bin/env bash
#
# Rolling out a specific release, 
# to a specific environment,
# on a specific site.
#
# Author: lovetravelsfaster
# Date: 2025-12-01
# License: MIT
source "$(dirname "$0")/helpers"

set -euo pipefail

SITE="${1:-}"
ENVIRONMENT="${2:-}"
RELEASE_ID="${3:-}"

ROLLOUT_ID=$(date +%Y-%m-%d_%H-%M-%S)

#############################
# First we check all the args
#############################

# This checks a given arg
check_arg() {
	local arg="$1"
	declare -l lower_arg
	lower_arg="$arg"
	local function="check_$lower_arg"
	if ssh deploy@lakelabs "bash -s -- "$function" "$SITE" "${!arg}"" < check-args; then
	    printf "$OK - $arg is valid\n"
	else
	    printf "$FAIL - $arg is not valid\n"
	    exit 1
	fi

}

# Checking them all
check_arg "SITE"
check_arg "ENVIRONMENT"
check_arg "RELEASE_ID"
printf "$OK - ALL args checked out OK\n"

printf "===============\n"

############################
# Then we write rollout logs
############################

# Setting up rollout_logs.txt if doesnt exist
rollout_log="/srv/www/clauslol/rollouts/rollout_log.txt"

ssh deploy@lakelabs 'bash -s' << EOF
if [[ ! -f "$rollout_log" ]]; then
    printf "# rollout_id\trelease_id\tenvironment\n" > "$rollout_log"
fi
EOF

# Writing rollout data to rollout_log.txt
if ssh deploy@lakelabs 'bash -s' << EOF
printf '%s\t%s\t%s\n' "$ROLLOUT_ID" "$RELEASE_ID" "$ENVIRONMENT" >> "$rollout_log"
EOF
then
	printf "$OK - Updated rollout_log\n"
	printf "\tROLLOUT_ID: $ROLLOUT_ID -- RELEASE_ID: $RELEASE_ID -- ENVIRONMENT: $ENVIRONMENT\n"
else
	printf "$FAIL - Something went wrong writing to rollout_log.txt\n"
	exit 1
fi

printf "===============\n"

########################
# Then we update symlink
########################

target=/srv/www/clauslol/releases/"$RELEASE_ID"
link=/srv/www/clauslol/"$ENVIRONMENT"

# Update symlink to new reality for environment
if ssh deploy@lakelabs 'bash -s' << EOF
	ln -sfn $target $link
EOF
then
	printf "$OK - Symlink updated\n"
	printf "\tTarget: $target\n"
	printf "\tLink: $link\n"
else
	printf "$FAIL - Something went wrong updateing symlink\n"
	exit 1
fi

